// Start Vivado
start_gui
// create the project location
create_project emio_gpio_vivado /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado -part xc7z020clg400-1
// select the board part
set_property board_part digilentinc.com:zybo-z7-20:part0:1.1 [current_project]
// create a block design
create_bd_design "emio_gpio_vivado"
update_compile_order -fileset sources_1
// add Zynq processing system
startgroup
create_bd_cell -type ip -vlnv xilinx.com:ip:processing_system7:5.5 processing_system7_0
endgroup
// Run automation
apply_bd_automation -rule xilinx.com:bd_rule:processing_system7 -config {make_external "FIXED_IO, DDR" apply_board_preset "1" Master "Disable" Slave "Disable" }  [get_bd_cells processing_system7_0]
// Add EMIO gpio with width = 4 to control 4 leds on the Zybo z7 20 board
startgroup
set_property -dict [list \
  CONFIG.PCW_ENET0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_EN_CLK0_PORT {0} \
  CONFIG.PCW_EN_RST0_PORT {0} \
  CONFIG.PCW_GPIO_EMIO_GPIO_ENABLE {1} \
  CONFIG.PCW_GPIO_EMIO_GPIO_IO {4} \
  CONFIG.PCW_GPIO_MIO_GPIO_ENABLE {1} \
  CONFIG.PCW_I2C_RESET_ENABLE {0} \
  CONFIG.PCW_QSPI_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_SD0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_USB0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_USB_RESET_ENABLE {0} \
  CONFIG.PCW_USE_M_AXI_GP0 {0} \
] [get_bd_cells processing_system7_0]
endgroup
// make the gpio pin as external and regenerate the layout
endgroup
startgroup
make_bd_intf_pins_external  [get_bd_intf_pins processing_system7_0/GPIO_0]
endgroup
regenerate_bd_layout
// change the gpio oin name to 'led' for easier understanding and access
set_property name led [get_bd_intf_ports GPIO_0_0]
// Validate the design
validate_bd_design
// create the HDL wrapper file
make_wrapper -files [get_files /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.srcs/sources_1/bd/emio_gpio_vivado/emio_gpio_vivado.bd] -top
add_files -norecurse /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.gen/sources_1/bd/emio_gpio_vivado/hdl/emio_gpio_vivado_wrapper.v
// run synthesis
launch_runs synth_1 -jobs 4
// add pin location to the led( this can be found in the Zynq z7 user guide or user the Master constraint file and enable only the pins that utilized)
open_run synth_1 -name synth_1
// set default voltage for the led pins
set_property IOSTANDARD LVCMOS33 [get_ports [list {led_tri_io[3]} {led_tri_io[2]} {led_tri_io[1]} {led_tri_io[0]}]]
// set the led pins
place_ports {led_tri_io[0]} M14
place_ports {led_tri_io[1]} M15
place_ports {led_tri_io[2]} G14
place_ports {led_tri_io[3]} D18
// save the constraint file
file mkdir /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.srcs/constrs_1/new
close [ open /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.srcs/constrs_1/new/constraint.xdc w ]
add_files -fileset constrs_1 /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.srcs/constrs_1/new/constraint.xdc
set_property target_constrs_file /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vivado/emio_gpio_vivado.srcs/constrs_1/new/constraint.xdc [current_fileset -constrset]
save_constraints -force
// generate bitstream
reset_run synth_1
launch_runs impl_1 -to_step write_bitstream -jobs 4
// export the hardware including the bitstream
file mkdir /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vitis
write_hw_platform -fixed -include_bit -force -file /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/emio_gpio/emio_gpio_vitis/emio_gpio_vivado_wrapper.xsa
