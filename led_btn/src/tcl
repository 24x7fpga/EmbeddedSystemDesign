// Start vivado and create the project
start_gui
create_project led_btn_vivado /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado -part xc7z020clg400-1
set_property board_part digilentinc.com:zybo-z7-20:part0:1.1 [current_project]

// Create block design
create_bd_design "led_btn_vivado"

// Add Zynq Processing system and apply board automation
startgroup
create_bd_cell -type ip -vlnv xilinx.com:ip:processing_system7:5.5 processing_system7_0
endgroup
apply_bd_automation -rule xilinx.com:bd_rule:processing_system7 -config {make_external "FIXED_IO, DDR" apply_board_preset "1" Master "Disable" Slave "Disable" }  [get_bd_cells processing_system7_0]

// Add the necessary pins 
startgroup
set_property -dict [list \
  CONFIG.PCW_ENET0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_EN_CLK0_PORT {0} \
  CONFIG.PCW_EN_RST0_PORT {0} \
  CONFIG.PCW_GPIO_EMIO_GPIO_ENABLE {1} \
  CONFIG.PCW_I2C_RESET_ENABLE {0} \
  CONFIG.PCW_QSPI_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_SD0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_USB0_PERIPHERAL_ENABLE {0} \
  CONFIG.PCW_USB_RESET_ENABLE {0} \
  CONFIG.PCW_USE_M_AXI_GP0 {0} \
] [get_bd_cells processing_system7_0] 
endgroup
regenerate_bd_layout

// Make gpio external pin
startgroup
make_bd_intf_pins_external  [get_bd_intf_pins processing_system7_0/GPIO_0]
endgroup
set_property name GPIO [get_bd_intf_ports GPIO_0_0]

// Use 8 bits for gpio ( first 4 buttons and the next 4 leds )
startgroup
set_property CONFIG.PCW_GPIO_EMIO_GPIO_IO {8} [get_bd_cells processing_system7_0] 
endgroup

// Create HDL wrapper
make_wrapper -files [get_files /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.srcs/sources_1/bd/led_btn_vivado/led_btn_vivado.bd] -top
add_files -norecurse /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.gen/sources_1/bd/led_btn_vivado/hdl/led_btn_vivado_wrapper.v

// Run synthesis
launch_runs synth_1 -jobs 4

//
open_run synth_1 -name synth_1
// Set voltage 
set_property IOSTANDARD LVCMOS33 [get_ports [list {GPIO_tri_io[7]} {GPIO_tri_io[6]} {GPIO_tri_io[5]} {GPIO_tri_io[4]} {GPIO_tri_io[3]} {GPIO_tri_io[2]} {GPIO_tri_io[1]} {GPIO_tri_io[0]}]]

// Place pins
place_ports {GPIO_tri_io[0]} G15
place_ports {GPIO_tri_io[1]} P15
place_ports {GPIO_tri_io[2]} W13
place_ports {GPIO_tri_io[3]} T16
place_ports {GPIO_tri_io[4]} M14
place_ports {GPIO_tri_io[5]} M15
place_ports {GPIO_tri_io[6]} G14
place_ports {GPIO_tri_io[7]} D18

// Save constraints file
file mkdir /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.srcs/constrs_1/new
close [ open /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.srcs/constrs_1/new/constraints.xdc w ]
add_files -fileset constrs_1 /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.srcs/constrs_1/new/constraints.xdc
set_property target_constrs_file /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vivado/led_btn_vivado.srcs/constrs_1/new/constraints.xdc [current_fileset -constrset]
save_constraints -force

// Create bitstream
reset_run synth_1
launch_runs impl_1 -to_step write_bitstream -jobs 4

// Export hardware
file mkdir /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vitis
write_hw_platform -fixed -include_bit -force -file /home/24x7fpga/Projects/fpgaProjects/EmbeddedSystemDesign/led_btn/led_btn_vitis/led_btn_vivado_wrapper.xsa
